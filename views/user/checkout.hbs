<div class="checkout">
    <div class="stack-lg" style="align-items:flex-start;">
        <div style="flex:2; min-width:0;">
            <div class="stack-md" style="align-items:center; justify-content:space-between;">
                <h2>Thanh toán</h2>
                <input id="addAddress" class="btn btn-outline" type="button" value="Thêm địa chỉ">
            </div>

            {{!-- Add new address form (collapsible) --}}
            <form action="/my-account/checkout/new-address" method="post" class="add-form card card-pad" style="margin-top:.75rem;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Họ và tên</label>
                        <input name="address_cust_name" type="text" class="input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Số điện thoại</label>
                        <input name="phone" type="text" class="input" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tên nhà/Địa chỉ</label>
                        <input name="house_name" type="text" class="input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phố/Đường</label>
                        <input name="area_street" type="text" class="input" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phường/Xã</label>
                        <input name="locality" type="text" class="input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quận/Huyện</label>
                        <input name="town" type="text" class="input" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tỉnh/Thành phố</label>
                        <input name="state" type="text" class="input" placeholder="Tỉnh/Thành phố" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mã bưu chính</label>
                        <input name="pincode" type="number" class="input" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Điểm mốc</label>
                        <input name="landmark" type="text" class="input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SĐT dự phòng</label>
                        <input name="alternate_phone" type="number" class="input">
                        <input name="customer_id" type="hidden" value="{{userData._id}}" class="input">
                    </div>
                </div>
                <div class="stack-md">
                    <div class="stack-md">
                        <label class="form-label">Loại địa chỉ</label>
                        <div class="stack-md">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" value="HOME" name="address_type" id="addrHome" checked>
                                <label class="form-check-label" for="addrHome">NHÀ</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" value="WORK" type="radio" name="address_type" id="addrWork">
                                <label class="form-check-label" for="addrWork">CÔNG TY</label>
                            </div>
                        </div>
                    </div>
                    <div class="stack-md" style="align-items:center;">
                        <input class="btn btn-primary" type="submit" value="Lưu địa chỉ" />
                        <input class="btn btn-outline" type="reset" autocomplete="on" value="Xóa" />
                        <a id="upButton" class="btn btn-outline" title="Thu gọn"><i class="fa-solid fa-angle-up"></i></a>
                    </div>
                </div>
            </form>

            {{!-- Address selection + Payment --}}
            <form id="orderForm" class="card card-pad" style="margin-top:1rem;">
                {{#each address}}
                <div class="address-container" style="display:flex; gap:.75rem; align-items:flex-start;">
                    <div class="form-check" style="margin-top:.35rem;">
                        <input id="addressInput" class="form-check-input" type="radio" name="address" value="{{this._id}}" required>
                    </div>
                    <div class="card card-pad" style="flex:1;">
                        <div class="stack-md" style="justify-content:space-between; align-items:center;">
                            <span class="badge badge-info" style="width:auto;">{{this.address_type}}</span>
                        </div>
                        <p class="lead">{{this.address_cust_name}} &emsp; {{this.phone}}</p>
                        <p class="muted">
                            {{this.house_name}} (H), {{this.locality}}, {{this.area_street}}, {{this.landmark}}, {{this.state}}
                            <span class="fw-bold">-{{this.pincode}}</span>
                        </p>
                    </div>
                </div>
                <hr>
                {{/each}}

                <input id="proceedPayment" class="btn btn-outline" type="button" value="Tiếp tục thanh toán">

                <div class="payment-options card card-pad" style="margin-top:.75rem;">
                    <div class="h6 mb-2">Phương thức thanh toán</div>
                    <div class="form-check">
                        <input class="form-check-input" value="COD" type="radio" name="payment_method" id="payCOD" checked>
                        <label class="form-check-label" for="payCOD">Thanh toán khi nhận hàng</label>
                    </div>
                    {{#if wallet}}
                    <div class="form-check">
                        <input class="form-check-input" value="wallet" type="radio" name="payment_method" id="payWallet">
                        <label class="form-check-label" for="payWallet">Ví Times Cart ({{formatVND user.user_wallet}})</label>
                    </div>
                    {{/if}}
                    <div class="form-check mb-3">
                        <input class="form-check-input" value="Online Payment" type="radio" name="payment_method" id="payOnline">
                        <label class="form-check-label" for="payOnline">MoMo (Ví điện tử)</label>
                    </div>

                    <input type="hidden" id="price" name="price" value="{{totalAmount}}">
                    <input type="hidden" id="discount" name="discount" value="">
                    <input type="hidden" id="coupen" name="coupen" value="">
                    <input type="hidden" id="coupen_code" name="coupen_code" value="">

                    <button class="btn btn-primary" id="submitOrder" style="width:100%;">Đặt hàng</button>
                </div>
            </form>
        </div>

        <div style="flex:1; min-width:280px;">
            <div role="button" id="checkCoupen" class="card card-pad" style="cursor:pointer;">
                <div class="stack-md" style="align-items:center;">
                    <i class="fa-solid fa-tags"></i>
                    <h4 class="mt-1">Kiểm tra mã giảm giá?</h4>
                </div>
            </div>

            <div class="card card-pad mt-3">
                <h5 class="mb-2">Tóm tắt</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                        Sản phẩm ({{cart.length}})
                        <span>{{formatVND totalAmount}}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Vận chuyển (miễn phí)
                        <span>{{formatVND 0}}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        Giảm giá:
                        <span id="showDiscount">0%</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3">
                        <div>
                            <strong>Tổng cộng</strong>
                            <p class="mb-0 muted">(đã bao gồm thuế)</p>
                        </div>
                        <span><strong>{{formatVND totalAmount}}</strong></span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    {{!-- Coupon modal --}}
    <div id="coupensBackdrop" class="backdrop"></div>
    <div class="coupenss card card-pad">
        <i id="back" role="button" class="fa-regular fa-circle-xmark text-danger" style="position:absolute; right:12px; top:12px;"></i>
        <h4 class="mb-2">Mã giảm giá khả dụng</h4>
        {{#each coupens}}
        <div class="card card-pad mb-2">
            <div class="stack-md" style="justify-content:space-between; align-items:center;">
                <input type="button" value="{{this.coupon_code}}" class="btn btn-sm btn-primary" role="button">
                <a class="fw-bold" style="text-decoration:none;" role="button" onclick="applayCoupen('{{this._id}}')">Áp dụng</a>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <p class="text-success fw-bold">Giảm giá: {{this.discount}}%</p>
                <p class="fw-bold text-secondary">HSD: {{this.exp_date}}<br>
                    <span class="fw-bold text-secondary">Tối thiểu: {{formatVND this.min_amount}}</span>
                </p>
            </div>
            <p class="text-secondary description fw-normal">{{this.discription}}</p>
            <div role="button" class="text-primary know-more h6">xem thêm</div>
            <div role="button" class="text-primary know-less h6">thu gọn</div>
        </div>
        {{/each}}
    </div>
</div>
