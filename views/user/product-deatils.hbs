<style>
  ::-webkit-scrollbar {
    height: 5px;
    width: 5px;
    background: #d9d9d9;
  }

  ::-webkit-scrollbar-thumb {
    background: #8fd4ff;
    -webkit-border-radius: 1ex;
  }
  /* Product details refinements */
  .price-vnd { font-weight: 700; color: #0b5ed7; letter-spacing: .2px; }
  .details-row dt { color: #666; }
  .details-row dd { color: #222; }
  .image-container { background: #f9fbfd; border-color: #e6effa !important; }
  #primary-img-view { transition: transform .25s ease; }
  .thumb { transition: transform .15s ease, box-shadow .15s ease; }
  .thumb:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,.08); }
  .border-primary { border-color: #0b5ed7 !important; }
  .action-buttons .btn { min-width: 140px; }

  /* Reviews section polish */
  .reviews { border: 1px solid #eef2f7; border-radius: .75rem; background: #fff; }
  .review-card { border: 1px solid #f1f3f7; border-radius: .75rem; background: #fff; }
  .review-user { font-weight: 600; margin-right: .75rem; color: #0f172a; }
  .review-rating { display: inline-flex; align-items: center; gap: .25rem; color: #f59e0b; font-weight: 600; }
  .review-comment { margin-top: .25rem; color: #334155; }
  .card-pad { padding: .75rem 1rem; }
</style>
<!-- content -->
<section class="py-5">
  <div class="container">
    <div class="row gx-5">
      <aside class="col-lg-6">
        <div id="image-container" class="border image-container rounded-4 mb-3 d-flex justify-content-center">
          {{#if product.wish}}
          <i id="heart{{product._id}}" class="fa-regular add-to-wish-list-btn fa-2x fa-heart"
            onclick="addToWishlist('{{product._id}}')" role="button"></i>
          {{else}}
          <i id="heart{{product._id}}" class="fa-solid text-danger add-to-wish-list-btn fa-2x fa-heart"
            onclick="addToWishlist('{{product._id}}')" role="button"></i>
          {{/if}}
          <img id="primary-img-view" class="rounded-4 fit primaryIMG" style="max-width:100%; object-fit:contain;"
            src="/productImages/{{product.primary_image.name}}" />
        </div>
        <div class="d-flex justify-content-center mb-3">
          <!-- Preview thumbnails: include primary + all secondary images -->
          <img width="60" height="60" role="button" id="thumb_primary" onclick="changeImage('primary')"
            class="border m-1 rounded-2 border-primary thumb" src="/productImages/{{product.primary_image.name}}" />
          {{#each product.secondary_images}}
          <img width="60" height="60" role="button" id="thumb_{{this._id}}" onclick="changeImage('{{this._id}}')"
            class="border m-1 rounded-2 thumb" src="/productImages/{{this.name}}" />
          {{/each}}
        </div>
      </aside>
      <main class="col-lg-6">
        <div class="ps-lg-3">
          <h4 class="title text-dark">
            {{product.product_name}} ({{avarage}}<i class="fa-solid fa-star text-warning"></i>)
          </h4>
          <div class="d-flex flex-row my-3">

            <span class="text-muted"><i class="fas fa-shopping-basket fa-sm mx-1"></i> Còn lại {{product.stock}}</span>
            <span class="text-success ms-2">Còn hàng</span>
          </div>
          <span class="h5 text-second price-vnd" id="detail-price">{{formatVND product.selling_price}}</span>
          <p>
            {{product.description}}
          </p>
          <div class="row details-row">
            <dt class="col-3">Màu sắc</dt>
            <dd class="col-9" style="text-transform:capitalize;">{{product.color}}</dd>

            <dt class="col-3">Thương hiệu</dt>
            <dd class="col-9">{{product.brand_name}}</dd>
          </div>
          <hr />

            <div class="action-buttons d-flex gap-2">
            <a onclick="buyNow('{{product._id}}')" class="btn btn-primary"> Mua ngay </a>
            <a onclick="addToCart('{{product._id}}')" class="btn btn-outline"> <i
              class="me-1 fa fa-shopping-basket"></i> Thêm vào giỏ </a>
            </div>
          
        </div>
        <div class="col-lg-12 d-flex justify-content-between align-items-center card card-pad mt-3">
          <h6 class="mt-1">Đánh giá & xếp hạng</h6>
          <i role="button" class="fa-solid reviewDown fa-caret-down"></i>
          <i role="button" class="fa-solid reviewup fa-caret-up"></i>
        </div>
        {{#if user}}
        <form id="rating-form" class="card card-pad mt-2" action="/review/submit" method="POST">
          <input type="hidden" name="product_id" value="{{product._id}}" />
          <div class="row g-2 align-items-center">
            <div class="col-12 col-md-4">
              <label for="rating" class="form-label">Chọn số sao</label>
              <select id="rating" name="rating" class="form-select">
                <option value="5">5 sao</option>
                <option value="4">4 sao</option>
                <option value="3">3 sao</option>
                <option value="2">2 sao</option>
                <option value="1">1 sao</option>
              </select>
            </div>
            <div class="col-12 col-md-8">
              <label for="comment" class="form-label">Nhận xét của bạn</label>
              <textarea id="comment" name="comment" class="form-control" rows="2" placeholder="Viết vài dòng cảm nhận..."></textarea>
            </div>
          </div>
          <div class="mt-2 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
          </div>
        </form>
        {{else}}
        <div class="card card-pad mt-2">
          <span class="muted">Đăng nhập để đánh giá sản phẩm.</span>
          <a href="/login" class="btn btn-outline mt-2">Đăng nhập</a>
        </div>
        {{/if}}
        <div class="reviews p-2 card mt-2" style="max-height:220px;overflow-y:auto">
          {{#each ratings}}
          <div class="card px-3 py-2 mt-2 review-card">
            <div class="card-title d-flex align-items-center">
              <span class="review-user">{{this.user.user_name}}</span>
              <span class="review-rating">
                {{this.rating}} <i class="fa-solid fa-star"></i>
              </span>
            </div>
            <p class="review-comment">{{this.comment}}</p>
          </div>
          {{/each}}
        </div>
      </main>
    </div>
  </div>
</section>
<!-- content -->

<script>
  $(document).ready(() => {


    const zoom_area = document.getElementById('image-container');
    const zoom_img = document.getElementById('primary-img-view');
    zoom_area.addEventListener('mousemove', (event) => {
      let clientX = event.clientX - zoom_area.offsetLeft;
      let clientY = event.clientY - zoom_area.offsetTop;
      const mWidth = zoom_area.offsetWidth;
      const mHeight = zoom_area.offsetHeight;
      clientX = clientX / mWidth * 100;
      clientY = clientY / mHeight * 100;
      zoom_img.style.transform = 'translate(-' + clientX + '%,-' + clientY + '%) scale(1.3)';
    });
    zoom_area.addEventListener('mouseleave', () => {
      zoom_img.style.transform = 'translate(-50%,-50%) scale(1)';
    });


    //change image function: set primary view to clicked thumbnail
    changeImage = (imgId) => {
      let src = '';
      if (imgId === 'primary') {
        src = document.getElementById('thumb_primary')?.src || '';
      } else {
        const thumb = document.getElementById(`thumb_${imgId}`);
        if (!thumb) return;
        src = thumb.src;
      }
      if (src) {
        zoom_img.src = src;
      }
      // active state border
      document.querySelectorAll('#thumb_primary, [id^="thumb_"]').forEach(el=>{
        el.classList.remove('border-primary');
      });
      const activeEl = imgId === 'primary' ? document.getElementById('thumb_primary') : document.getElementById(`thumb_${imgId}`);
      activeEl?.classList.add('border-primary');
    }

    $('.reviewup').hide();
    $('.reviews').hide();

    $('.reviewDown').on('click', () => {
      $('.reviewup').show();
      $('.reviews').slideDown();
      $('.reviewDown').hide();
    })
    $('.reviewup').on('click', () => {
      $('.reviewup').hide();
      $('.reviewDown').show();
      $('.reviews').slideUp();
    })




  });

  // Buy now: ensure in cart, then open cart with only this item selected
  async function buyNow(pid){
    try {
      if (typeof addToCart === 'function') {
        await addToCart(pid);
      } else {
        await fetch(`/cart/add-to-cart/${pid}`, { method: 'GET' });
      }
    } catch (e) {
      // ignore
    }
    window.location.href = `/cart?select=${encodeURIComponent(pid)}`;
  }

  // Price is rendered server-side via {{formatVND}}

  // Client-side validation before submit rating
  (function(){
    const form = document.getElementById('rating-form');
    if (!form) return;
    form.addEventListener('submit', function(e){
      const rating = Number(document.getElementById('rating')?.value || 0);
      const comment = (document.getElementById('comment')?.value || '').trim();
      if (!(rating >= 1 && rating <= 5)){
        e.preventDefault();
        alert('Vui lòng chọn số sao từ 1 đến 5');
        return;
      }
      if (comment.length < 5){
        e.preventDefault();
        alert('Nhận xét quá ngắn, vui lòng viết ít nhất 5 ký tự');
        return;
      }
    });
  })();
</script>
